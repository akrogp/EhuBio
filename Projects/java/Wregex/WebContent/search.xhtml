<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:body>
	<ui:composition template="./template.xhtml">
		<ui:define name="title">Search</ui:define>
		<ui:define name="htmlhead">
			<meta name="description" content="Wregex search page. A novel approach for amino acid motif searching combining a regular expression with a Position-Specific Scoring Matrix (PSSM)."/>
		</ui:define>
		<ui:define name="content">
<!-- 			<h:form enctype="multipart/form-data" rendered="#{databasesBean.initialized}"> -->
			<h:form enctype="multipart/form-data">
				<p:panelGrid headerClass="cfg_header">
					<f:facet name="header">Search configuration</f:facet>
					
					<p:row>
						<p:column>Motif:</p:column>
						<p:column>
							<p:selectOneMenu value="#{motifView.mainMotif.motif}"
								valueChangeListener="#{motifView.onChangeMainMotif}">
								<f:selectItem itemLabel="--- Select motif ---"
									itemValue="Default" />
<!-- 								<f:selectItem itemLabel="All motifs" itemValue="All" /> -->
								<f:selectItem itemLabel="Custom" itemValue="Custom" />
								<f:selectItems value="#{databasesBean.wregexMotifs}" />
								<f:selectItem
									itemLabel="--- #{databasesBean.elmInformation.fullName} ---"
									itemValue="ELM" />
								<f:selectItems value="#{databasesBean.elmMotifs}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
							<p:selectOneMenu value="#{motifView.mainMotif.configuration}"
								valueChangeListener="#{motifView.onChangeMainDefinition}"
								rendered="#{motifView.mainMotif.motifInformation != null and !motifView.mainMotif.custom }">
								<f:selectItem itemLabel="--- Select configuration ---" itemValue="Default" />
								<f:selectItems value="#{motifView.mainMotif.definitions}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">
							<p:selectOneMenu value="#{motifView.auxMotif.motif}"
								valueChangeListener="#{motifView.onChangeAuxMotif}">
								<f:selectItem itemLabel="--- Select motif ---"
									itemValue="Default" />
								<f:selectItems value="#{databasesBean.wregexMotifs}" />
								<f:selectItem
									itemLabel="--- #{databasesBean.elmInformation.fullName} ---"
									itemValue="ELM" />
								<f:selectItems value="#{databasesBean.elmMotifs}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
							<p:selectOneMenu value="#{motifView.auxMotif.configuration}"
								valueChangeListener="#{motifView.onChangeAuxDefinition}"
								rendered="#{motifView.auxMotif.motifInformation != null}">
								<f:selectItem itemLabel="--- Select configuration ---" itemValue="Default" />
								<f:selectItems value="#{motifView.auxMotif.definitions}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
						</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>Summary:</p:column>
						<p:column>#{motifView.mainMotif.summary}</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.summary}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>Description:</p:column>
						<p:column>#{motifView.mainMotif.description}</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.description}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>References:</p:column>
						<p:column>					
							<p:dataList value="#{motifView.mainMotif.references}" var="ref" type="ordered" emptyMessage="">
								<h:outputLink value="#{ref.link}" target="_blank">
									<h:outputText value="#{ref.html}" escape="false"/>&nbsp;<h:graphicImage name="images/link.png" height="15"/>
								</h:outputLink>
							</p:dataList>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">					
							<p:dataList value="#{motifView.auxMotif.references}" var="ref" type="ordered" emptyMessage="">
								<h:outputLink value="#{ref.link}" target="_blank">
									<h:outputText value="#{ref.html}" escape="false"/>&nbsp;<h:graphicImage name="images/link.png" height="15"/>
								</h:outputLink>
							</p:dataList>
						</p:column>					
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails or motifView.mainMotif.custom}">
						<p:column>Regex:</p:column>
						<p:column>
							<h:outputText value="#{motifView.mainMotif.regex}" rendered="#{!motifView.mainMotif.custom and !motifView.allMotifs}"/>
							<h:outputText value="All Wregex and ELM regular expressions" rendered="#{motifView.allMotifs}"/>
							<p:inputText value="#{motifView.mainMotif.customRegex}" rendered="#{motifView.mainMotif.custom}" styleClass="trn_regex">
								<p:ajax event="change" update="@form"/>
							</p:inputText>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.regex}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails or motifView.mainMotif.custom}">
						<p:column>PSSM file:</p:column>
						<p:column>
							<h:panelGroup rendered="#{!motifView.mainMotif.custom and !motifView.allMotifs}">
								<h:outputText value="#{motifView.mainMotif.pssmFile}" />
								<h:outputText
									value="Not available (scores will not be available)"
									rendered="#{motifView.mainMotif.motifInformation != null and motifView.mainMotif.pssmFile == null}" />
								<p:commandButton value="Download"
									actionListener="#{searchView.downloadPssm}"
									rendered="#{motifView.mainMotif.pssmFile != null}" ajax="false" />
							</h:panelGroup>
							<h:outputText
								value="Scores will be available only for motifs with a PSSM (Wregex but not ELM)"
								rendered="#{motifView.allMotifs}" />
							<h:panelGroup rendered="#{motifView.mainMotif.custom}">
								<p:fileUpload fileUploadListener="#{motifView.uploadPssm}"
									mode="advanced" sizeLimit="#{initParam['wregex.pssm']}"
									multiple="false" auto="true" label="Select PSSM" update="@form"
									allowTypes="/(\.|\/)(te?xt|pssm)$/" style="width:400px;" />
								<h:outputText id="pssm" value="#{motifView.pssmSummary}" />
							</h:panelGroup>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">
							#{motifView.auxMotif.pssmFile}
							<p:commandButton value="Download"
								actionListener="#{searchView.downloadAuxPssm}"
								rendered="#{motifView.auxMotif.pssmFile != null}" ajax="false" />
						</p:column>					
            		</p:row>
            		
            		<p:row>
            			<p:column>Target:</p:column>
            			<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<p:panelGrid style="border-style:hidden;">
								<p:row>
								<p:column>
									<p:selectOneMenu value="#{targetView.target}"
										valueChangeListener="#{targetView.onChangeTarget}">
										<f:selectItem itemLabel="--- Select target ---" itemValue="Default" />
										<f:selectItems value="#{databasesBean.targets}" />
										<p:ajax update="@form" />
									</p:selectOneMenu>
									<h:panelGroup rendered="#{targetView.manualTarget and !targetView.manualSubproteome}">
										<br/><br/>Enter text:<br/>	
										<p:inputTextarea value="#{targetView.inputText}" rows="6" cols="80" placeholder="#{targetView.targetInformation.hint}">
											<p:ajax event="change" update="@form" listener="#{targetView.onChangeInput()}"/>
										</p:inputTextarea>
										<br/>or:<br/>
										<p:fileUpload fileUploadListener="#{targetView.uploadFile}"
											mode="advanced" sizeLimit="#{initParam['wregex.fasta']}"
											multiple="false" auto="true" label="Select file"
											update="@form" allowTypes="#{targetView.targetInformation.extPattern}"
											style="width:400px;" />
									</h:panelGroup>
									<h:panelGroup rendered="#{targetView.manualSubproteome}">
										<br/><br/>Enter Gene Ontology term:<br/>
										<p:autoComplete minQueryLength="3" forceSelection="true" maxResults="10" value="#{targetView.inputText}" completeMethod="#{targetView.completeGo}" placeholder="#{targetView.targetInformation.hint}" size="40">
											<p:ajax event="itemSelect" listener="#{targetView.onChangeInput()}" update="@form"/>
										</p:autoComplete>
									</h:panelGroup>
								</p:column>								
								<p:column rendered="#{targetView.fastaSummary != null}">
									<h:outputText id="fasta" value="#{targetView.fastaSummary}" />
								</p:column>
								</p:row>
							</p:panelGrid>
						</p:column>						
            		</p:row>
            	
            		<p:row>
            			<p:column>Options:</p:column>	
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<p:selectBooleanCheckbox itemLabel="Grouping" value="#{searchOptionsView.grouping}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							&nbsp;
							<h:panelGroup rendered="#{homeView.development}">
								<p:selectBooleanCheckbox itemLabel="Filter similar" value="#{searchOptionsView.filterEqual}" valueChangeListener="#{searchView.onChangeOption}">
									<p:ajax event="change" update="@form" />
								</p:selectBooleanCheckbox>
								&nbsp;Threshold:
								<p:spinner value="#{searchOptionsView.scoreThreshold}" valueChangeListener="#{searchView.onChangeOption}" min="0.00" max="100.00" stepFactor="10.00" size="7">
									<p:ajax event="change" update="@form" />
								</p:spinner>
								&nbsp;Flanking:
								<p:spinner value="#{searchOptionsView.flanking}" valueChangeListener="#{searchView.onChangeOption}" min="0" suffix=" aa" size="5">
									<p:ajax event="change" update="@form" />
								</p:spinner>
								&nbsp;
								<p:selectBooleanCheckbox itemLabel="Auxiliar motif" value="#{motifView.useAuxMotif}" valueChangeListener="#{searchView.onChangeOption}" update="@form">
									<p:ajax event="change" update="@form" />
								</p:selectBooleanCheckbox>
								&nbsp;
							</h:panelGroup>							
						</p:column>
					</p:row>
					
					<p:row>
            			<p:column style="vertical-align:baseline;">Connections:</p:column>
            			<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
            				<p:selectBooleanCheckbox itemLabel="#{databasesBean.cosmicInformation.fullName}" value="#{searchOptionsView.cosmic}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							<br/>
							<p:selectBooleanCheckbox itemLabel="#{databasesBean.dbPtmInformation.fullName}" value="#{searchOptionsView.dbPtm}" valueChangeListener="#{searchView.onChangeOption}" rendered="#{homeView.development}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							<p:selectManyCheckbox rendered="#{searchOptionsView.dbPtm}" layout="grid" columns="6" style="margin-left:20px;" value="#{searchOptionsView.selectedPtms}">
								<p:ajax event="change" update="@form" />
								<f:selectItems value="#{databasesBean.ptms}"/>
							</p:selectManyCheckbox>
            			</p:column>
           			</p:row>
					
					<p:row rendered="#{searchView.configError != null}">
						<p:column>Status:</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText value="#{searchView.configError}" style="color:red"/>
						</p:column>						
					</p:row>
					
					<p:row rendered="#{searchView.configError == null and searchView.results == null}">
						<p:column>
							<p:commandButton value="Search!" actionListener="#{searchView.search}" ajax="false"/>
						</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText id="search" value="#{searchView.searchError}" rendered="#{searchView.searchError != null}" style="color:red"/>
						</p:column>
					</p:row>
					
					<p:row rendered="#{searchView.results != null and searchView.configError == null and searchView.searchError == null}">
						<p:column>Results:</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText value="#{searchView.numberOfResults}"/>&nbsp;
							<p:commandButton value="Download as CSV" rendered="#{not empty searchView.results}" actionListener="#{searchView.downloadCsv}" ajax="false"/>
							<p:commandButton value="Download as ALN" rendered="#{not empty searchView.results}" actionListener="#{searchView.downloadAln}" ajax="false"/>
						</p:column>
					</p:row>
				</p:panelGrid>
				
				<br/>
				<p:dataTable value="#{searchView.results}" rowIndexVar="row" var="item" rendered="#{searchView.results != null and searchView.configError == null}" scrollable="true" scrollHeight="300" liveScroll="true" scrollRows="40">
					<f:facet name="header">Search results - live scroll (scroll and wait for more results)</f:facet>
					<p:column width="50" style="text-align:center;">
						<f:facet name="header">#</f:facet>
						<h:outputText value="#{row + 1}"/>
					</p:column>
					<p:column width="250">
						<f:facet name="header">Entry</f:facet>
						<h:outputText value="#{item.entry}" rendered="#{item.protUrl == null}"/>
						<h:outputLink value="#{item.protUrl}" target="_blank" rendered="#{item.protUrl != null}">#{item.entry}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column styleClass="trn_pos">
						<f:facet name="header">Start</f:facet>
						<h:outputText value="#{item.start}"/>
					</p:column>
					<p:column styleClass="trn_pos">
						<f:facet name="header">End</f:facet>
						<h:outputText value="#{item.end}"/>
					</p:column>
					<p:column rendered="#{motifView.allMotifs}" width="200">
						<f:facet name="header">Motif</f:facet>
						<h:outputLink value="#{item.motifUrl}" target="_blank">#{item.motif}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column>
						<f:facet name="header">Sequence</f:facet>
						<h:outputText value="#{item.alignment}"/>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic and motifView.usingPssm}">
						<f:facet name="header">Mutant</f:facet>
						<h:outputText value="#{item.mutLeft}"/>
						<h:outputText value="#{item.mutAa}" style="color:red"/>
						<h:outputText value="#{item.mutRight}"/>
					</p:column>
					<p:column styleClass="trn_pos">
						<f:facet name="header">"!"</f:facet>
						<h:outputText value="#{item.combinations}"/>
					</p:column>
					<p:column styleClass="trn_weight">
						<f:facet name="header">Score</f:facet>
						<h:outputText value="#{item.scoreAsString}" rendered="#{motifView.usingPssm}" />
						<h:outputText value="N/A" rendered="#{!motifView.usingPssm}"/>
					</p:column>
					<p:column rendered="#{searchView.assayScores}" styleClass="trn_weight">
						<f:facet name="header">Assay</f:facet>
						<h:outputText value="#{item.assayAsString}"/>
					</p:column>
					<p:column styleClass="trn_weight" rendered="#{motifView.useAuxMotif}">
						<f:facet name="header">Aux score</f:facet>
						<h:outputText value="#{item.auxScoreAsString}"/>
					</p:column>		
					<p:column rendered="#{searchOptionsView.cosmic}" width="100">
						<f:facet name="header">Gene</f:facet>
						<h:outputText value="#{item.gene}"/>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic}" width="80" style="text-align:center;">
						<f:facet name="header">COSMIC missense</f:facet>
						<h:outputText rendered="#{item.cosmicUrl == null}" value="#{item.cosmicMissenseAsString}"/>
						<h:outputLink rendered="#{item.cosmicUrl != null}" value="#{item.cosmicUrl}" target="_blank">#{item.cosmicMissenseAsString}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic and motifView.usingPssm}" width="80" style="text-align:center;">
						<f:facet name="header">Mutation impact</f:facet>
						<h:outputText value="NA" rendered="#{item.mutScore == null}"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore lt 0}" style="color:red"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore gt 0}" style="color:blue"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore == 0}"/>						
					</p:column>
					<p:columns value="#{searchOptionsView.selectedPtms}" var="ptm" rendered="#{searchOptionsView.dbPtm}" width="80" style="text-align:center;text-overflow:ellipsis;">
						<f:facet name="header">#{ptm}</f:facet>
						<h:outputText value="#{item.ptmCounts.get(ptm)}" />
					</p:columns>
					<p:column rendered="#{searchOptionsView.dbPtm}" width="80" style="text-align:center;">
						<f:facet name="header">dbPTM entries</f:facet>
						<h:outputText rendered="#{item.dbPtmUrl == null}" value="#{item.dbPtmsAsString}"/>
						<h:outputLink rendered="#{item.dbPtmUrl != null}" value="#{item.dbPtmUrl}" target="_blank">#{item.dbPtmsAsString}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>					
				</p:dataTable>
			</h:form>
<!-- 			<h:outputText value="Sorry, databases are beeing updated, please try again later" rendered="#{!databasesBean.initialized}"/> -->
		</ui:define>
	</ui:composition>
</h:body>
</html>