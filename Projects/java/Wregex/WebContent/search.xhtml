<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:body>
	<ui:composition template="./WEB-INF/templates/template.xhtml">
		<ui:define name="title">Search</ui:define>
		<ui:define name="htmlhead">
			<meta name="description" content="Wregex search page. A novel approach for amino acid motif searching combining a regular expression with a Position-Specific Scoring Matrix (PSSM)."/>
		</ui:define>
		<ui:define name="content">
<!-- 			<h:form enctype="multipart/form-data" rendered="#{databasesBean.initialized}"> -->
			<h:form enctype="multipart/form-data" id="searchForm">
				<p:panelGrid headerClass="cfg_header">
					<f:facet name="header">Search configuration</f:facet>
					
					<p:row>
						<p:column>Preset:</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<p:selectOneMenu id="preset" value="#{searchView.preset}" valueChangeListener="#{searchView.onSelectPreset}">
								<f:selectItems value="#{databasesBean.presets}" var="preset" itemLabel="#{preset.name}" itemValue="#{preset.value}"/>
								<p:ajax event="change" update="@form" />
							</p:selectOneMenu>
						</p:column>
					</p:row>
					
					<p:row>
						<p:column>Motif:</p:column>
						<p:column>
							<p:selectOneMenu value="#{motifView.mainMotif.motif}"
								valueChangeListener="#{motifView.onChangeMainMotif}">
								<f:selectItem itemLabel="--- Select motif ---"
									itemValue="none" />
 								<f:selectItem itemLabel="All motifs" itemValue="All" />
								<f:selectItem itemLabel="Custom" itemValue="Custom" />
								<f:selectItems value="#{databasesBean.wregexMotifs}" />
								<f:selectItem
									itemLabel="--- #{databasesBean.elmInformation.fullName} ---"
									itemValue="ELM" />
								<f:selectItem itemLabel="All ELM motifs" itemValue="AllELM" />
								<f:selectItems value="#{databasesBean.elmMotifs}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>&nbsp;
							<p:selectOneMenu value="#{motifView.mainMotif.configuration}"
								valueChangeListener="#{motifView.onChangeMainDefinition}"
								rendered="#{motifView.mainMotif.motifInformation != null and !motifView.mainMotif.custom }">
								<f:selectItem itemLabel="--- Select configuration ---" itemValue="Default" />
								<f:selectItems value="#{motifView.mainMotif.definitions}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">
							<p:selectOneMenu value="#{motifView.auxMotif.motif}"
								valueChangeListener="#{motifView.onChangeAuxMotif}">
								<f:selectItem itemLabel="--- Select motif ---"
									itemValue="none" />
								<f:selectItems value="#{databasesBean.wregexMotifs}" />
								<f:selectItem
									itemLabel="--- #{databasesBean.elmInformation.fullName} ---"
									itemValue="ELM" />
								<f:selectItems value="#{databasesBean.elmMotifs}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
							<p:selectOneMenu value="#{motifView.auxMotif.configuration}"
								valueChangeListener="#{motifView.onChangeAuxDefinition}"
								rendered="#{motifView.auxMotif.motifInformation != null}">
								<f:selectItem itemLabel="--- Select configuration ---" itemValue="Default" />
								<f:selectItems value="#{motifView.auxMotif.definitions}" />
								<p:ajax update="@form" />
							</p:selectOneMenu>
						</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>Summary:</p:column>
						<p:column>#{motifView.mainMotif.summary}</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.summary}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>Description:</p:column>
						<p:column>#{motifView.mainMotif.description}</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.description}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails}">
						<p:column>References:</p:column>
						<p:column>					
							<p:dataList value="#{motifView.mainMotif.references}" var="ref" type="ordered" emptyMessage="">
								<h:outputLink value="#{ref.link}" target="_blank">
									<h:outputText value="#{ref.html}" escape="false"/>&nbsp;<h:graphicImage name="images/link.png" height="15"/>
								</h:outputLink>
							</p:dataList>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">					
							<p:dataList value="#{motifView.auxMotif.references}" var="ref" type="ordered" emptyMessage="">
								<h:outputLink value="#{ref.link}" target="_blank">
									<h:outputText value="#{ref.html}" escape="false"/>&nbsp;<h:graphicImage name="images/link.png" height="15"/>
								</h:outputLink>
							</p:dataList>
						</p:column>					
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails or motifView.mainMotif.custom}">
						<p:column>Regex:</p:column>
						<p:column>
							<h:outputText value="#{motifView.mainMotif.regex}" rendered="#{!motifView.mainMotif.custom and !motifView.allMotifs}"/>
							<h:outputText value="All Wregex and ELM regular expressions" rendered="#{motifView.allMotifs}"/>
							<p:inputText value="#{motifView.mainMotif.customRegex}" rendered="#{motifView.mainMotif.custom}" styleClass="trn_regex">
								<p:ajax event="change" update="@form"/>
							</p:inputText>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">#{motifView.auxMotif.regex}</p:column>
					</p:row>
					
					<p:row rendered="#{motifView.showMotifDetails or motifView.mainMotif.custom}">
						<p:column>PSSM file:</p:column>
						<p:column>
							<h:panelGroup rendered="#{!motifView.mainMotif.custom and !motifView.allMotifs}">
								<h:outputText value="#{motifView.mainMotif.pssmFile}" />
								<h:outputText
									value="Not available (scores will not be available)"
									rendered="#{motifView.mainMotif.motifInformation != null and motifView.mainMotif.pssmFile == null}" />&nbsp;
								<p:commandButton value="Download"
									actionListener="#{searchView.downloadPssm}"
									rendered="#{motifView.mainMotif.pssmFile != null}" ajax="false" />
							</h:panelGroup>
							<h:outputText
								value="Scores will be available only for motifs with a PSSM (Wregex but not ELM)"
								rendered="#{motifView.allMotifs}" />
							<h:panelGroup rendered="#{motifView.mainMotif.custom}">
								<p:fileUpload fileUploadListener="#{motifView.uploadPssm}"
									mode="advanced" sizeLimit="#{initParam['wregex.pssm']}"
									multiple="false" auto="true" label="Select PSSM" update="@form"
									allowTypes="/(\.|\/)(te?xt|pssm)$/" style="width:400px;" />
								<h:outputText id="pssm" value="#{motifView.pssmSummary}" />
							</h:panelGroup>
						</p:column>
						<p:column rendered="#{motifView.useAuxMotif}">
							#{motifView.auxMotif.pssmFile}
							<p:commandButton value="Download"
								actionListener="#{searchView.downloadAuxPssm}"
								rendered="#{motifView.auxMotif.pssmFile != null}" ajax="false" />
						</p:column>					
            		</p:row>
            		
            		<p:row>
            			<p:column>Target:</p:column>
            			<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<p:panelGrid style="border-style:hidden;">
								<p:row>
								<p:column>
									<p:selectOneMenu id="targetSelect" value="#{targetView.target}"
										valueChangeListener="#{targetView.onChangeTarget}">
										<f:selectItem itemLabel="--- Select target ---" itemValue="none" />
										<f:selectItems value="#{databasesBean.targets}" var="db" itemLabel="#{db.fullName}" itemValue="#{db.name}" itemDisabled="#{db.type == 'separator'}"/>
										<p:ajax update="@form" />
									</p:selectOneMenu>
									<h:panelGroup rendered="#{targetView.manualTarget and !targetView.manualSubproteome}">
										<br/><br/>Enter text:<br/>	
										<p:inputTextarea value="#{targetView.inputText}" rows="6" cols="80" placeholder="#{targetView.targetInformation.hint}">
											<p:ajax event="change" update="@form" listener="#{targetView.onChangeInput()}"/>
										</p:inputTextarea>
										<br/>or:<br/>
										<p:fileUpload fileUploadListener="#{targetView.uploadFile}"
											mode="advanced" sizeLimit="#{initParam['wregex.fasta']}"
											multiple="false" auto="true" label="Select file"
											update="@form" allowTypes="#{targetView.targetInformation.extPattern}"
											style="width:400px;" />
									</h:panelGroup>
									<h:panelGroup rendered="#{targetView.manualSubproteome}">
										<br/><br/>Enter Gene Ontology term:<br/>
										<p:autoComplete id="goInput" minQueryLength="3" forceSelection="true" maxResults="100" scrollHeight="250" size="40"
											value="#{targetView.inputText}" completeMethod="#{targetView.completeGo}" placeholder="#{targetView.targetInformation.hint}">
											<p:ajax event="itemSelect" listener="#{targetView.onChangeInput()}" update="@form"/>
										</p:autoComplete>
									</h:panelGroup>									
								</p:column>								
								<p:column rendered="#{targetView.fastaSummary != null}">
									<h:panelGroup>										
										<p:selectBooleanCheckbox id="decoy" itemLabel="Build decoy" value="#{targetView.decoy}" valueChangeListener="#{targetView.onChangeDecoy}">
											<p:ajax event="change" update="@form" />
										</p:selectBooleanCheckbox>
										<p:tooltip for="decoy" value="Shuffles amino acids (starting at the second one) for each sequence"/>
										<br/><br/>
									</h:panelGroup>
									<h:outputText id="fasta" value="#{targetView.fastaSummary}" />&nbsp;
									<p:commandButton value="Download Fasta" ajax="false" action="#{searchView.downloadFasta()}"/>
								</p:column>
								</p:row>
							</p:panelGrid>
						</p:column>						
            		</p:row>
            	
            		<p:row>
            			<p:column>Options:</p:column>	
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<p:selectBooleanCheckbox id="grouping" itemLabel="Grouping" value="#{searchOptionsView.grouping}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							<p:tooltip for="grouping" value="Collapse overlapping candidates into a single result"/>
							&nbsp;
							<p:selectBooleanCheckbox id="similar" itemLabel="Filter similar" value="#{searchOptionsView.filterEqual}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							<p:tooltip for="similar" value="Remove results with the same matching sequence"/>
							&nbsp;
							<p:selectBooleanCheckbox id="auxiliary" itemLabel="Auxiliary motif" value="#{motifView.useAuxMotif}" valueChangeListener="#{searchView.onChangeOption}" update="@form">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox><br/><br/>
							<p:tooltip for="auxiliary" value="Enable a second auxiliary motif"/>
							Threshold:								
							<p:spinner id="threshold" value="#{searchOptionsView.scoreThreshold}" valueChangeListener="#{searchView.onChangeOption}" min="0.00" max="100.00" stepFactor="10.00" size="7">
								<p:ajax event="change" update="@form" />
							</p:spinner>
							<p:tooltip for="threshold" value="Score threshold for main motif matches"/>
							&nbsp;Flanking:
							<p:spinner id="flanking" value="#{searchOptionsView.flanking}" valueChangeListener="#{searchView.onChangeOption}" min="0" suffix=" aa" size="5">
								<p:ajax event="change" update="@form" />
							</p:spinner>
							<p:tooltip for="flanking" value="Number of additional amino acids to show at both sides of the match"/>							
						</p:column>
					</p:row>
					
					<p:row>
            			<p:column style="vertical-align:baseline;"><br/>Connections:</p:column>
            			<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
            				<p:selectBooleanCheckbox itemLabel="#{databasesBean.cosmicInformation.fullName}" value="#{searchOptionsView.cosmic}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>
							<br/><br/>
							<p:selectBooleanCheckbox itemLabel="PhosphoSitePlus (20220909)" value="#{searchOptionsView.psp}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>&nbsp;&nbsp;		
							<p:selectBooleanCheckbox itemLabel="#{databasesBean.dbPtmInformation.fullName}" value="#{searchOptionsView.dbPtm}" valueChangeListener="#{searchView.onChangeOption}">
								<p:ajax event="change" update="@form" />
							</p:selectBooleanCheckbox>							
							<p:selectManyCheckbox rendered="#{searchOptionsView.dbPtm}" layout="grid" columns="6" style="margin-left:20px;" value="#{searchOptionsView.selectedPtms}">
								<p:ajax event="change" update="@form" />
								<f:selectItems value="#{databasesBean.dbPtms}"/>
							</p:selectManyCheckbox>
							<p:selectManyCheckbox rendered="#{searchOptionsView.psp}" layout="grid" columns="4" style="margin-left:20px;" value="#{searchOptionsView.selectedPtms}">
								<p:ajax event="change" update="@form" />
								<f:selectItems value="#{databasesBean.pspPtms}"/>
							</p:selectManyCheckbox>
            			</p:column>
           			</p:row>
					
					<p:row rendered="#{searchView.configError != null}">
						<p:column>Status:</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText value="#{searchView.configError}" style="color:red"/>
						</p:column>						
					</p:row>
					
					<p:row rendered="#{searchView.configError == null and searchView.results == null}">
						<p:column>
							<p:commandButton value="Search!" actionListener="#{searchView.search}" ajax="false"/>
						</p:column>&nbsp;
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText id="search" value="#{searchView.searchError}" rendered="#{searchView.searchError != null}" style="color:red"/>
						</p:column>
					</p:row>
					
					<p:row rendered="#{searchView.results != null and searchView.configError == null and searchView.searchError == null}">
						<p:column>Results:</p:column>
						<p:column colspan="#{motifView.useAuxMotif ? 2 : 1}">
							<h:outputText value="#{searchView.numberOfResults}"/>&nbsp;
							<p:commandButton value="Download as CSV" rendered="#{not empty searchView.results}" actionListener="#{searchView.downloadCsv}" ajax="false"/>
							<p:commandButton value="Download as ALN" rendered="#{not empty searchView.results}" actionListener="#{searchView.downloadAln}" ajax="false"/>
						</p:column>
					</p:row>
				</p:panelGrid>
				
				<br/>
				<p:dataTable value="#{searchView.results}" rowIndexVar="row" var="item" rendered="#{searchView.results != null and searchView.configError == null}" scrollable="true" scrollHeight="300" liveScroll="true" scrollRows="40">
					<f:facet name="header">Search results - live scroll (scroll and wait for more results)</f:facet>
					<p:column width="50" style="text-align:center;" id="search_id">
						<f:facet name="header">
							#
							<p:tooltip value="Result rank" for="search_id"/>
						</f:facet>
						<h:outputText value="#{row + 1}"/>
					</p:column>
					<p:column width="250" id="search_entry">
						<f:facet name="header">
							Entry
							<p:tooltip value="Fasta header before first space" for="search_entry"/>
						</f:facet>
						<h:outputText value="#{item.entry}" rendered="#{item.protUrl == null}"/>
						<h:outputLink value="#{item.protUrl}" target="_blank" rendered="#{item.protUrl != null}">#{item.entry}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column id="search_start" styleClass="trn_pos">
						<f:facet name="header">
							Start
							<p:tooltip value="Start position of the motif in the entry sequence" for="search_start"/>
						</f:facet>						
						<h:outputText value="#{item.start}"/>
					</p:column>
					<p:column id="search_stop" styleClass="trn_pos">
						<f:facet name="header">
							End
							<p:tooltip value="End position of the motif in the entry sequence" for="search_stop"/>
						</f:facet>
						<h:outputText value="#{item.end}"/>
					</p:column>
					<p:column rendered="#{motifView.allMotifs}" width="200">
						<f:facet name="header">Motif</f:facet>
						<h:outputLink value="#{item.motifUrl}" target="_blank">#{item.motif}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column id="search_seq">
						<f:facet name="header">
							Sequence
							<p:tooltip value="Sequence of motif match separating capturing groups (if any)" for="search_seq"/>
						</f:facet>
						<h:outputText value="#{item.alignment}"/>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic and motifView.usingPssm}" id="search_mutant">
						<f:facet name="header">
							Mutant
							<p:tooltip value="Mutation in motif match sequence (lost if no more matches)" for="search_mutant"/>
						</f:facet>
						<h:outputText value="#{item.mutLeft}"/>
						<h:outputText value="#{item.mutAa}" style="color:red"/>
						<h:outputText value="#{item.mutRight}"/>
					</p:column>
					<p:column styleClass="trn_pos" id="search_comb">
						<f:facet name="header">
							"!"
							<p:tooltip value="Number of overlapping motif matches" for="search_comb"/>
						</f:facet>
						<h:outputText value="#{item.combinations}"/>
					</p:column>
					<p:column styleClass="trn_weight" id="search_score">
						<f:facet name="header">
							Score
							<p:tooltip value="Wregex score" for="search_score"/>
						</f:facet>
						<h:outputText value="#{item.scoreAsString}" rendered="#{motifView.usingPssm}" />
						<h:outputText value="N/A" rendered="#{!motifView.usingPssm}"/>
					</p:column>
					<p:column rendered="#{searchView.assayScores}" styleClass="trn_weight">
						<f:facet name="header">Assay</f:facet>
						<h:outputText value="#{item.assayAsString}"/>
					</p:column>
					<p:column styleClass="trn_weight" rendered="#{motifView.useAuxMotif}">
						<f:facet name="header">Aux score</f:facet>
						<h:outputText value="#{item.auxScoreAsString}"/>
					</p:column>		
					<p:column rendered="#{searchOptionsView.cosmic}" width="100" id="search_gene">
						<f:facet name="header">
							Gene
							<p:tooltip value="Gene name used for external searches" for="search_gene"/>
						</f:facet>
						<h:outputText value="#{item.gene}"/>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic}" width="80" style="text-align:center;" id="search_cosmic">
						<f:facet name="header">
							COSMIC missense
							<p:tooltip value="Mutation count" for="search_cosmic"/>
						</f:facet>
						<h:outputText rendered="#{item.cosmicUrl == null}" value="#{item.cosmicMissenseAsString}"/>
						<h:outputLink rendered="#{item.cosmicUrl != null}" value="#{item.cosmicUrl}" target="_blank">#{item.cosmicMissenseAsString}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>
					<p:column rendered="#{searchOptionsView.cosmic and motifView.usingPssm}" width="80" style="text-align:center;" id="search_impact">
						<f:facet name="header">
							Mutation impact
							<p:tooltip value="Impact on Wregex score after mutation" for="search_impact"/>
						</f:facet>
						<h:outputText value="NA" rendered="#{item.mutScore == null}"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore lt 0}" style="color:red"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore gt 0}" style="color:blue"/>
						<h:outputText value="#{item.mutScoreAsString}" rendered="#{item.mutScore != null and item.mutScore == 0}"/>						
					</p:column>
					<p:columns value="#{searchOptionsView.selectedPtms}" var="ptm" rendered="#{searchOptionsView.ptm}" width="80" style="text-align:center;text-overflow:ellipsis;">
						<f:facet name="header">
							#{ptm}
						</f:facet>
						<h:outputText value="#{item.ptmCounts.get(ptm)}" />
					</p:columns>
					<p:column rendered="#{searchOptionsView.ptm}" width="80" style="text-align:center;" id="search_ptms">
						<f:facet name="header">
							Total PTMs
							<p:tooltip value="Total number of PTMs (of any type) within the motif match" for="search_ptms"/>
						</f:facet>
						<h:outputText rendered="#{item.ptmUrl == null}" value="#{item.totalPtmsAsString}"/>
						<h:outputLink rendered="#{item.ptmUrl != null}" value="#{item.ptmUrl}" target="_blank">#{item.totalPtmsAsString}&nbsp;<h:graphicImage name="images/link.png" height="15"/></h:outputLink>
					</p:column>					
				</p:dataTable>
				<p:blockUI block="searchForm" trigger="preset, goInput">
					Loading...
				</p:blockUI>
			</h:form>
<!-- 			<h:outputText value="Sorry, databases are beeing updated, please try again later" rendered="#{!databasesBean.initialized}"/> -->
		</ui:define>
	</ui:composition>
</h:body>
</html>